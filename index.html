<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OptiGrid | CO₂ Offset & ROI Calculator</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      /* OptiGrid-like dark theme */
      --bg: #07121f;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.12);
      --text: #e8eef9;
      --muted: rgba(232,238,249,0.75);

      --blue: #2b77ff;         /* Update button */
      --green: #3e8f6a;        /* matte green PDF button */
      --greenHover: #347a5a;

      --radius: 18px;
      --shadow: 0 18px 50px rgba(0,0,0,0.35);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(43,119,255,0.18), transparent 55%),
                  radial-gradient(900px 500px at 80% 20%, rgba(62,143,106,0.15), transparent 60%),
                  var(--bg);
      color: var(--text);
    }

    /* Top header (website) */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(10px);
      background: rgba(7,18,31,0.75);
      border-bottom: 1px solid var(--border);
    }

    .topbar-inner {
      max-width: 1100px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .logo img {
      height: 26px;
      width: auto;
      display: block;
    }

    .logo-title {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .logo-title strong {
      font-size: 13px;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .logo-title span {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 20px 60px;
    }

    /* Report container (also what PDF exports) */
    #report {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
    }

    /* PDF header (inside report so it appears in PDF) */
    .report-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 18px 18px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--border);
    }

    .report-header img {
      height: 30px;
      width: auto;
      display: block;
    }

    .report-header .titles {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .report-header .titles .h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .report-header .titles .h2 {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .content {
      padding: 18px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .grid { grid-template-columns: 1.05fr 0.95fr; }
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      background: var(--panel);
    }

    .card h2 {
      margin: 0 0 10px 0;
      font-size: 15px;
      letter-spacing: 0.2px;
    }

    .subtext {
      margin: 0 0 14px 0;
      color: var(--muted);
      font-size: 13px;
    }

    .field { margin-bottom: 12px; }
    label {
      display: block;
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 6px;
    }

    input {
      width: 100%;
      padding: 11px 12px;
      font-size: 15px;
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 12px;
      outline: none;
      background: rgba(0,0,0,0.16);
      color: var(--text);
    }
    input:focus {
      border-color: rgba(43,119,255,0.55);
      box-shadow: 0 0 0 4px rgba(43,119,255,0.15);
    }

    .info {
      background: var(--panel2);
      border: 1px dashed rgba(255,255,255,0.16);
      border-radius: 14px;
      padding: 12px;
      color: var(--text);
      font-size: 13px;
    }
    .info ul { margin: 8px 0 0 18px; padding: 0; }
    .info li { margin: 6px 0; color: rgba(232,238,249,0.85); }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 12px;
    }

    button {
      border: none;
      border-radius: 12px;
      padding: 12px 14px;
      font-size: 14px;
      font-weight: 800;
      cursor: pointer;
      transition: transform 0.05s ease, filter 0.15s ease, background 0.15s ease;
      color: #ffffff;
    }
    button:active { transform: translateY(1px); }

    /* Update (calculate) button */
    .btn-update {
      background: linear-gradient(180deg, rgba(43,119,255,1), rgba(25,90,210,1));
      box-shadow: 0 10px 24px rgba(43,119,255,0.25);
    }
    .btn-update:hover { filter: brightness(1.04); }

    /* Download PDF button (bottom, matte green) */
    .btn-pdf {
      width: 100%;
      background: linear-gradient(180deg, var(--green), #2f6f52);
      box-shadow: 0 10px 26px rgba(62,143,106,0.22);
      padding: 14px 16px;
      border-radius: 14px;
      font-size: 15px;
    }
    .btn-pdf:hover { background: linear-gradient(180deg, var(--greenHover), #2a6248); }

    /* Results block */
    #roiResults {
      display: none;
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.14);
    }
    #roiResults h2 {
      margin: 0 0 8px 0;
      font-size: 14px;
    }
    .result-line {
      margin: 6px 0;
      font-size: 13.5px;
      color: rgba(232,238,249,0.92);
    }
    .result-line span { font-weight: 900; }

    /* Charts */
    .charts {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .chart-block {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    .chart-title {
      margin: 0 0 10px 0;
      font-size: 13px;
      font-weight: 900;
      color: rgba(232,238,249,0.95);
    }

    .chart-wrap {
      position: relative;
      width: 100%;
      height: 360px; /* key fix: chart fits properly */
    }

    @media (min-width: 900px) {
      .chart-wrap { height: 380px; }
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    /* Notes */
    .notes { page-break-inside: avoid; }
    .notes h2 { margin: 0 0 8px 0; font-size: 14px; }
    .notes ul { margin: 0 0 0 18px; padding: 0; }
    .notes li { margin: 6px 0; color: rgba(232,238,249,0.85); font-size: 13px; }

    .footer-actions {
      margin-top: 18px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .fineprint {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(232,238,249,0.62);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
  <!-- Website header -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="logo">
        <img alt="OptiGrid logo" src="https://optigrid.energy/logos/logo.webp" />
        <div class="logo-title">
          <strong>OptiGrid</strong>
          <span>CO₂ Offset & ROI Calculator</span>
        </div>
      </div>
    </div>
  </div>

  <div class="page">
    <!-- Exported area -->
    <div id="report">
      <div class="report-header">
        <img alt="OptiGrid logo" src="https://optigrid.energy/logos/logo.webp" />
        <div class="titles">
          <p class="h1">CO₂ Offset Calculator</p>
          <p class="h2">Decarbonisation modelling + ROI & payback analysis</p>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <!-- Inputs -->
          <div class="card">
            <h2>Inputs</h2>
            <p class="subtext">After updating figures, press <strong>Update</strong>.</p>

            <div class="field">
              <label>Battery Capacity (MWh per battery)</label>
              <input type="number" id="capacity" value="3.9" />
            </div>

            <div class="info">
              <div><strong>Battery quantities analysed:</strong> 1, 250, 500, 750, 1000 batteries</div>
              <div style="margin-top:8px;"><strong>Fixed Emission Factors:</strong></div>
              <ul>
                <li>Brown Coal: 336.6 kg CO₂/MWh</li>
                <li>Black Coal: 324 kg CO₂/MWh</li>
              </ul>
            </div>

            <div class="btn-row">
              <button class="btn-update" onclick="calculate()">Update</button>
            </div>

            <div id="roiResults">
              <h2>ROI & Payback Analysis</h2>
              <div class="result-line"><strong>Normal Payback Period:</strong> <span id="paybackNormal"></span> years</div>
              <div class="result-line"><strong>Optimised Payback Period:</strong> <span id="paybackOptimised"></span> years</div>
              <div class="result-line"><strong>ROI Improvement:</strong> <span id="roiImprovement"></span> %</div>
            </div>
          </div>

          <!-- ROI Inputs -->
          <div class="card">
            <h2>ROI Calculator</h2>
            <p class="subtext">Enter assumptions below, then press <strong>Update</strong> to refresh results.</p>

            <div class="field">
              <label>Project Cost ($)</label>
              <input type="number" id="cost" value="1000000" />
            </div>

            <div class="field">
              <label>Annual Revenue — Normal Operation ($/year)</label>
              <input type="number" id="revenueNormal" value="120000" />
            </div>

            <div class="field">
              <label>Annual Revenue — Optimised Operation ($/year)</label>
              <input type="number" id="revenueOptimised" value="180000" />
            </div>

            <div class="info">
              <strong>Tip:</strong> After updating figures, press <strong>Update</strong>.
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="charts">
          <div class="card chart-block">
            <p class="chart-title">Decarbonisation vs Number of Batteries</p>
            <div class="chart-wrap">
              <canvas id="batteryChart"></canvas>
            </div>
          </div>

          <div class="card chart-block">
            <p class="chart-title">Decarbonisation vs Time (Years) for 500 Batteries</p>
            <div class="chart-wrap">
              <canvas id="timeChart"></canvas>
            </div>
          </div>

          <div class="card notes">
            <h2>Notes</h2>
            <ul>
              <li><strong>Formula used:</strong></li>
              <li>CE = (C × 365 × EF × N<sub>years</sub> × N<sub>batteries</sub>) / 1000</li>
              <li>
                where:<br>
                CE = Carbon Emission (tons/year)<br>
                C = Battery Capacity<br>
                EF = Black/Brown coal Emission Factor<br>
                N<sub>years</sub> = Number of years<br>
                N<sub>batteries</sub> = Number of batteries
              </li>
              <li><strong>ROI & Payback formulas:</strong></li>
              <li>Payback<sub>Normal</sub> = Project Cost / Annual Revenue<sub>Normal</sub></li>
              <li>Payback<sub>Optimised</sub> = Project Cost / Annual Revenue<sub>Optimised</sub></li>
              <li>ROI Improvement (%) = (1 − Payback<sub>Optimised</sub> / Payback<sub>Normal</sub>) × 100</li>
              <li>Calculation is based on Tesla Megapack with a lifespan of 20 years.</li>
              <li>Calculation does not account for emissions from transport, manufacturing, or battery degradation.</li>
            </ul>
          </div>
        </div>

        <!-- Bottom PDF button -->
        <div class="footer-actions">
          <button class="btn-pdf" onclick="downloadPDF()">Download PDF</button>

          <div class="fineprint">
            <span>OptiGrid — CO₂ Offset & ROI Calculator</span>
            <span>PDF generated in-browser</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // IMPORTANT: LOGIC / CALCULATIONS BELOW ARE NOT CHANGED.

    function calculate() {
      const capacity = Number(document.getElementById("capacity").value);
      const brownEF = 336.6;
      const blackEF = 324;

      const batteryQuantities = [1, 250, 500, 750, 1000];
      const timeYears = [5, 10, 15, 20];
      const fixedBatteryForTime = 500;

      const blackBatteryData = batteryQuantities.map(b => (capacity * 365 * blackEF / 1000) * b);
      const brownBatteryData = batteryQuantities.map(b => (capacity * 365 * brownEF / 1000) * b);

      const blackTimeData = timeYears.map(t => (capacity * 365 * blackEF / 1000) * fixedBatteryForTime * t);
      const brownTimeData = timeYears.map(t => (capacity * 365 * brownEF / 1000) * fixedBatteryForTime * t);

      if (window.batteryChartInstance) window.batteryChartInstance.destroy();
      if (window.timeChartInstance) window.timeChartInstance.destroy();

      // Shared chart styling to match OptiGrid dark theme (visual only, no math changes)
      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "top",
            labels: {
              color: "rgba(232,238,249,0.9)",
              boxWidth: 14,
              boxHeight: 14,
              padding: 18,
              font: { size: 12, weight: "bold" }
            }
          },
          tooltip: {
            enabled: true
          }
        },
        scales: {
          x: {
            ticks: { color: "rgba(232,238,249,0.85)", font: { size: 12 } },
            grid: { color: "rgba(255,255,255,0.08)" },
            title: { display: true, color: "rgba(232,238,249,0.9)", font: { size: 14, weight: "bold" } }
          },
          y: {
            ticks: { color: "rgba(232,238,249,0.85)", font: { size: 12 } },
            grid: { color: "rgba(255,255,255,0.08)" },
            title: { display: true, color: "rgba(232,238,249,0.9)", font: { size: 14, weight: "bold" } }
          }
        },
        elements: {
          line: { borderWidth: 3, tension: 0.2 },
          point: { radius: 4, hoverRadius: 6 }
        }
      };

      const ctxBattery = document.getElementById("batteryChart").getContext("2d");
      window.batteryChartInstance = new Chart(ctxBattery, {
        type: "line",
        data: {
          labels: batteryQuantities,
          datasets: [
            { label: "Black Coal", data: blackBatteryData, borderColor: "blue", borderWidth: 2, fill: false, tension: 0.2 },
            { label: "Brown Coal", data: brownBatteryData, borderColor: "orange", borderWidth: 2, fill: false, tension: 0.2 }
          ]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales,
            x: { ...commonOptions.scales.x, title: { ...commonOptions.scales.x.title, text: "Number of Batteries" } },
            y: { ...commonOptions.scales.y, title: { ...commonOptions.scales.y.title, text: "Decarbonisation (tonnes/year)" } }
          }
        }
      });

      const ctxTime = document.getElementById("timeChart").getContext("2d");
      window.timeChartInstance = new Chart(ctxTime, {
        type: "line",
        data: {
          labels: timeYears,
          datasets: [
            { label: "Black Coal", data: blackTimeData, borderColor: "blue", borderWidth: 2, fill: false, tension: 0.2 },
            { label: "Brown Coal", data: brownTimeData, borderColor: "orange", borderWidth: 2, fill: false, tension: 0.2 }
          ]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales,
            x: { ...commonOptions.scales.x, title: { ...commonOptions.scales.x.title, text: "Time (Years)" } },
            y: { ...commonOptions.scales.y, title: { ...commonOptions.scales.y.title, text: "Decarbonisation (tonnes)" } }
          }
        }
      });

      const cost = Number(document.getElementById("cost").value);
      const revenueNormal = Number(document.getElementById("revenueNormal").value);
      const revenueOptimised = Number(document.getElementById("revenueOptimised").value);

      if (cost > 0 && revenueNormal > 0 && revenueOptimised > 0) {
        const paybackNormal = cost / revenueNormal;
        const paybackOptimised = cost / revenueOptimised;
        const roiImprovement = (1 - paybackOptimised / paybackNormal) * 100;

        document.getElementById("paybackNormal").innerText = paybackNormal.toFixed(2);
        document.getElementById("paybackOptimised").innerText = paybackOptimised.toFixed(2);
        document.getElementById("roiImprovement").innerText = roiImprovement.toFixed(1);

        document.getElementById("roiResults").style.display = "block";
      }
    }

    function downloadPDF() {
      const element = document.getElementById("report");

      const opt = {
        margin: [0.4, 0.4, 0.4, 0.4],
        filename: 'battery_co2_report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
      };

      setTimeout(() => {
        html2pdf().set(opt).from(element).save();
      }, 500);
    }

    // Optional: draw once on load using defaults (no math changes)
    window.addEventListener("load", () => calculate());
  </script>
</body>
</html>
