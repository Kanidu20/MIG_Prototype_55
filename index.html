<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OptiGrid | CO₂ Offset & ROI Calculator</title>

  <!-- Chart.js + html2pdf -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      /* Brand blues */
      --brandBlue:  #0b2a4a;
      --brandBlue2: #0a2340;
      --deepBlue:   #071c33;
      --deepBlue2:  #06162a;

      --text: #ffffff;
      --muted: rgba(255,255,255,0.82);

      /* Panels */
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.10);
      --border: rgba(255,255,255,0.16);

      /* Inputs */
      --inputBg: rgba(255,255,255,0.08);
      --inputBgFocus: rgba(255,255,255,0.11);
      --inputBorder: rgba(255,255,255,0.22);
      --inputText: rgba(255,255,255,0.95);
      --inputPlaceholder: rgba(255,255,255,0.55);

      /* Buttons (liquid glass) */
      --btnBlueA: rgba(30,78,216,0.34);
      --btnBlueB: rgba(30,78,216,0.18);
      --btnBlueBorder: rgba(147,197,253,0.38);

      --btnGreenA: rgba(22,163,74,0.34);
      --btnGreenB: rgba(22,163,74,0.18);
      --btnGreenBorder: rgba(134,239,172,0.40);

      --goodGreen: #22c55e;

      /* Chart colours (match your line graphs) */
      --coalBlackLine: rgba(71,176,214,1);   /* teal/blue */
      --coalBrownLine: rgba(255,122,138,1);  /* coral/pink */

      /* Greens for ROI pie */
      --g1: #dcfce7;
      --g2: #86efac;
      --g3: #22c55e;
      --g4: #16a34a;
      --g5: #14532d;

      --radius: 18px;
      --shadow: 0 18px 50px rgba(0,0,0,0.35);

      /* PDF mode */
      --pdfBg: #ffffff;
      --pdfText: #000000;
      --pdfBorder: rgba(0,0,0,0.18);
      --pdfShadow: 0 10px 26px rgba(0,0,0,0.08);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: linear-gradient(180deg, var(--deepBlue), var(--deepBlue2));
      color: var(--text);
    }

    /* Top bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      background: linear-gradient(180deg, var(--brandBlue), var(--brandBlue2));
      border-bottom: 1px solid rgba(255,255,255,0.18);
    }
    .topbar-inner{
      max-width: 1120px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .brand img{
      height: 26px;
      width:auto;
      display:block;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.25));
    }
    .brand-text{
      display:grid;
      gap:2px;
      min-width:0;
      color:#fff;
    }
    .brand-text .title{
      font-weight:900;
      font-size:13px;
      letter-spacing:0.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand-text .subtitle{
      font-size:12px;
      color: rgba(255,255,255,0.82);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .page{
      max-width: 1120px;
      margin: 0 auto;
      padding: 18px 18px 56px;
    }

    /* Report wrapper */
    #report{
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.10);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
    }

    /* Header inside report */
    .report-header{
      padding: 18px 18px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.00));
      border-bottom: 1px solid rgba(255,255,255,0.12);
    }
    .hero{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .hero-left{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      text-align:center;
    }
    .hero-left img{ height:28px; width:auto; display:block; }
    .hero h1{
      margin:0;
      font-size: 26px;
      font-weight: 900;
      letter-spacing: 0.2px;
      width:100%;
      text-align:center; /* ✅ centered title */
    }
    .hero p{
      margin: 8px auto 0 auto;
      color: var(--muted);
      line-height: 1.5;
      font-size: 13.5px;
      max-width: 980px;
      text-align:center;
    }

    .content{ padding: 18px; }

    /* Cards */
    .card{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      background: var(--panel);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .card h2{
      margin: 0 0 10px 0;
      font-size: 18px;
      font-weight: 900;
      text-align:center;
      color: rgba(255,255,255,0.96);
    }
    .subtext{
      margin: 0 0 14px 0;
      color: var(--muted);
      font-size: 13.5px;
      line-height: 1.55;
      text-align: center;
    }

    /* Inputs at top (two boxes) */
    .input-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 900px){
      .input-grid{ grid-template-columns: 1fr 1fr; }
    }

    /* ✅ Inputs stacked within each card */
    .inputs{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    label{
      display:block;
      font-size: 13px;
      font-weight: 800;
      margin-bottom: 6px;
      color: rgba(255,255,255,0.92);
    }

    input[type="number"]{
      width:100%;
      padding: 11px 12px;
      font-size: 15px;
      border-radius: 12px;
      outline: none;
      border: 1px solid var(--inputBorder);
      background: var(--inputBg);
      color: var(--inputText);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    input[type="number"]::placeholder{ color: var(--inputPlaceholder); }
    input[type="number"]:focus{
      background: var(--inputBgFocus);
      border-color: rgba(255,255,255,0.34);
    }

    .hint{
      margin-top: 6px;
      font-size: 12px;
      color: rgba(255,255,255,0.74);
    }

    /* Slider */
    .slider-wrap{
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
    }
    .slider-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .slider-value{
      font-weight: 900;
      font-size: 14px;
      color: rgba(255,255,255,0.95);
    }
    input[type="range"]{
      width:100%;
      margin-top: 10px;
      accent-color: #60a5fa;
    }

    /* ✅ Submit button full-width across one line */
    .submit-row{
      margin-top: 14px;
    }

    /* ✅ Liquid-glass buttons */
    button{
      width:100%;
      border-radius: 14px;
      padding: 13px 14px;
      font-size: 15px;
      font-weight: 900;
      cursor: pointer;
      color: #fff;

      border: 1px solid rgba(255,255,255,0.22);
      background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.10));
      box-shadow:
        0 14px 30px rgba(0,0,0,0.22),
        inset 0 1px 0 rgba(255,255,255,0.24);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);

      transition: transform 0.05s ease, filter 0.15s ease;
    }
    button:active{ transform: translateY(1px); }

    /* matte blue look on top of glass */
    .btn-submit{
      background:
        linear-gradient(180deg, var(--btnBlueA), var(--btnBlueB)),
        linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.10));
      border-color: var(--btnBlueBorder);
    }
    .btn-submit:hover{ filter: brightness(1.05); }

    /* ✅ Save as PDF at bottom + green */
    .btn-pdf{
      background:
        linear-gradient(180deg, var(--btnGreenA), var(--btnGreenB)),
        linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.10));
      border-color: var(--btnGreenBorder);
    }
    .btn-pdf:hover{ filter: brightness(1.05); }

    /* ROI summary */
    #roiSummary{
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      display:none;
    }
    #roiSummary h3{
      margin:0 0 8px 0;
      text-align:center;
      font-size: 15px;
      font-weight: 900;
      color: rgba(255,255,255,0.95);
    }
    .result-line{
      margin: 7px 0;
      text-align:center;
      color: rgba(255,255,255,0.90);
      font-size: 13.5px;
    }
    .result-line span{
      font-weight: 900;
      color: var(--goodGreen);
    }

    /* Sections */
    .section{
      margin-top: 16px;
    }

    /* ✅ Pie charts: 3 in a row on desktop, stacked on mobile */
    .pie-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media (min-width: 980px){
      .pie-grid{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .chart-card{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      background: var(--panel);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .chart-title{
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 900;
      text-align:center;
      color: rgba(255,255,255,0.96);
    }
    .chart-explain{
      margin: 0 0 12px 0;
      text-align:center;
      color: var(--muted);
      line-height: 1.55;
      font-size: 13.5px;
    }

    .canvas-wrap{
      position:relative;
      width:100%;
      height: 290px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.10);
      padding: 10px;
    }
    @media (min-width: 700px){
      .canvas-wrap{ height: 320px; }
    }
    canvas{
      width:100% !important;
      height:100% !important;
      display:block;
    }

    /* Notes dropdown */
    details.notes{
      margin-top: 16px;
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 16px;
      padding: 12px 14px;
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    details.notes summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
      font-size: 16px;
      color: rgba(255,255,255,0.95);
    }
    details.notes summary::-webkit-details-marker{ display:none; }
    .pill{
      font-size: 12px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.16);
      color: rgba(255,255,255,0.88);
    }
    .chev{
      width: 12px; height: 12px;
      border-right: 3px solid rgba(255,255,255,0.80);
      border-bottom: 3px solid rgba(255,255,255,0.80);
      transform: rotate(45deg);
      transition: transform 0.15s ease;
      flex: 0 0 auto;
    }
    details.notes[open] .chev{ transform: rotate(-135deg); }
    .notes-body{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.90);
      line-height: 1.6;
      font-size: 13.5px;
    }
    .notes-body ul{ margin: 0 0 0 18px; padding: 0; }
    .notes-body li{ margin: 7px 0; color: rgba(255,255,255,0.88); }
    .notes-body .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    .fineprint{
      margin-top: 14px;
      font-size: 12px;
      color: rgba(255,255,255,0.70);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* ===================== PDF MODE ===================== */
    #report.pdfMode{
      background: var(--pdfBg) !important;
      border-color: var(--pdfBorder) !important;
      box-shadow: var(--pdfShadow) !important;
      color: var(--pdfText) !important;
    }
    #report.pdfMode, #report.pdfMode *{ color: var(--pdfText) !important; }
    #report.pdfMode .report-header{
      background:#ffffff !important;
      border-bottom-color: var(--pdfBorder) !important;
    }
    #report.pdfMode .card,
    #report.pdfMode .chart-card,
    #report.pdfMode details.notes{
      background:#ffffff !important;
      border-color: var(--pdfBorder) !important;
      backdrop-filter:none !important;
      -webkit-backdrop-filter:none !important;
      box-shadow:none !important;
    }
    #report.pdfMode input[type="number"]{
      background:#ffffff !important;
      border-color: var(--pdfBorder) !important;
      color:#000 !important;
    }
    #report.pdfMode .canvas-wrap{
      background:#ffffff !important;
      border-color: var(--pdfBorder) !important;
    }
    /* Keep buttons hidden in PDF export */
    #report.pdfMode button{ display:none !important; }

    @media print{
      *{ -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      body{ background:#fff !important; margin:0 !important; }
      .topbar{ display:none !important; }
      .page{ padding:0 !important; max-width:none !important; }
      #report{ border-radius:0 !important; box-shadow:none !important; }
      .card, .chart-card, details.notes, .canvas-wrap { break-inside: avoid !important; page-break-inside: avoid !important; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img alt="OptiGrid logo" src="https://optigrid.energy/logos/logo.webp" />
        <div class="brand-text">
          <div class="title">OptiGrid x Team 55 MIG</div>
          <div class="subtitle">CO₂ Offset & ROI Calculator</div>
        </div>
      </div>
      <div></div>
    </div>
  </div>

  <div class="page">
    <div id="report">
      <div class="report-header">
        <div class="hero">
          <div class="hero-left">
            <img alt="OptiGrid logo" src="https://optigrid.energy/logos/logo.webp" />
            <h1>CO₂ Offset & ROI Calculator</h1>
            <p>
              Enter your values and press <strong>Submit</strong>. You’ll get an indicative view of (1) annual offset share (pie charts),
              (2) ROI/payback change, and (3) scale + time trend charts.
            </p>
          </div>
        </div>
      </div>

      <div class="content">
        <!-- INPUTS -->
        <div class="input-grid">
          <div class="card">
            <h2>Inputs</h2>
            <p class="subtext">
              These values drive the emissions and ROI estimates. All fields are capped at <strong>1,000,000</strong> and cannot be negative.
            </p>

            <div class="inputs">
              <div>
                <label>Battery Capacity (MWh)</label>
                <input type="number" id="capacity" value="3.9" min="0" max="1000000" step="0.1" />
                <div class="hint">Size of one battery unit.</div>
              </div>

              <div>
                <label>Total Annual Grid Emissions (t CO₂)</label>
                <input type="number" id="totalEmissions" value="500000" min="0" max="1000000" step="1" />
                <div class="hint">Used to show offset as a share (%).</div>
              </div>
            </div>

            <div class="slider-wrap">
              <div class="slider-top">
                <div style="font-weight:900;">Number of Batteries Deployed</div>
                <div class="slider-value"><span id="batteryCount">500</span> batteries</div>
              </div>
              <input type="range" id="batterySlider" min="0" max="1000" step="50" value="500" />
              <div class="hint">Move the slider to test different deployment sizes.</div>
            </div>
          </div>

          <div class="card">
            <h2>ROI Inputs</h2>
            <p class="subtext">
              Payback is a simple “years to recover cost” estimate. Optimised assumes higher annual revenue.
            </p>

            <div class="inputs">
              <div>
                <label>Project Cost ($)</label>
                <input type="number" id="cost" value="1000000" min="0" max="1000000" step="1" />
                <div class="hint">Total upfront cost.</div>
              </div>

              <div>
                <label>Annual Revenue — Normal ($/year)</label>
                <input type="number" id="revNormal" value="120000" min="0" max="1000000" step="1" />
                <div class="hint">Expected yearly revenue in a baseline case.</div>
              </div>

              <div>
                <label>Annual Revenue — Optimised ($/year)</label>
                <input type="number" id="revOpt" value="180000" min="0" max="1000000" step="1" />
                <div class="hint">Expected yearly revenue with optimisation.</div>
              </div>
            </div>

            <div id="roiSummary">
              <h3>ROI & Payback Summary</h3>
              <div class="result-line"><strong>Normal Payback:</strong> <span id="pbN"></span> years</div>
              <div class="result-line"><strong>Optimised Payback:</strong> <span id="pbO"></span> years</div>
              <div class="result-line"><strong>ROI Improvement:</strong> <span id="roiGain"></span> %</div>
            </div>
          </div>
        </div>

        <!-- ✅ Submit full-width below both cards -->
        <div class="submit-row">
          <button class="btn-submit" id="submitBtn" type="button">Submit</button>
        </div>

        <!-- ✅ PIE CHARTS: 3 across -->
        <div class="section">
          <div class="chart-card">
            <p class="chart-title">Offset Share & ROI Snapshot (Annual)</p>
            <p class="chart-explain">
              Left: offset share using the Black Coal factor (same colour style as the line chart).
              Middle: offset share using the Brown Coal factor. Right: ROI improvement (green shades).
            </p>

            <div class="pie-grid">
              <div>
                <p style="margin:0 0 8px 0; text-align:center; font-weight:900; color:rgba(255,255,255,0.92);">Black Coal Offset Share</p>
                <div class="canvas-wrap"><canvas id="blackPie"></canvas></div>
              </div>

              <div>
                <p style="margin:0 0 8px 0; text-align:center; font-weight:900; color:rgba(255,255,255,0.92);">Brown Coal Offset Share</p>
                <div class="canvas-wrap"><canvas id="brownPie"></canvas></div>
              </div>

              <div>
                <p style="margin:0 0 8px 0; text-align:center; font-weight:900; color:rgba(255,255,255,0.92);">ROI Improvement</p>
                <div class="canvas-wrap"><canvas id="roiPie"></canvas></div>
              </div>
            </div>
          </div>
        </div>

        <!-- LINE CHARTS -->
        <div class="section">
          <div class="chart-card">
            <p class="chart-title">Emissions Offset vs Number of Batteries</p>
            <p class="chart-explain">
              Trend view: as the number of batteries increases, the estimated annual offset increases.
            </p>
            <div class="canvas-wrap"><canvas id="batteryChart"></canvas></div>
          </div>

          <div class="chart-card" style="margin-top:16px;">
            <p class="chart-title">Emissions Offset over Time (500 Batteries)</p>
            <p class="chart-explain">
              Trend view: shows how offset can accumulate over 5–20 years for 500 batteries.
            </p>
            <div class="canvas-wrap"><canvas id="timeChart"></canvas></div>
          </div>
        </div>

        <!-- ✅ Notes (exact content added) -->
        <details class="notes" open>
          <summary>
            <span style="display:flex; align-items:center; gap:10px;">
              Notes <span class="pill">More info</span>
            </span>
            <span class="chev" aria-hidden="true"></span>
          </summary>
          <div class="notes-body">
            <ul>
              <li><strong>Formula used:</strong></li>
              <li class="mono">CE = (C × 365 × EF × N<sub>years</sub> × N<sub>batteries</sub>) / 1000</li>
              <li><strong>where:</strong><br>
                CE = Carbon Emission (tons/year)<br>
                C = Battery Capacity<br>
                EF = Black/Brown coal Emission Factor<br>
                N<sub>years</sub> = Number of years<br>
                N<sub>batteries</sub> = Number of batteries
              </li>
              <li><strong>ROI &amp; Payback formulas:</strong></li>
              <li class="mono">Payback<sub>Normal</sub> = Project Cost / Annual Revenue<sub>Normal</sub></li>
              <li class="mono">Payback<sub>Optimised</sub> = Project Cost / Annual Revenue<sub>Optimised</sub></li>
              <li class="mono">ROI Improvement (%) = (1 − Payback<sub>Optimised</sub> / Payback<sub>Normal</sub>) × 100</li>
              <li>Calculation is based on Tesla Megapack with a lifespan of 20 years.</li>
              <li>Calculation does not account for emissions from transport, manufacturing, or battery degradation.</li>
            </ul>
          </div>
        </details>

        <!-- ✅ Save as PDF at bottom (green) -->
        <div class="section" style="margin-top:16px;">
          <button class="btn-pdf" id="pdfBtn" type="button">Save as PDF</button>
        </div>

        <div class="fineprint">
          <span>OptiGrid x Team 55 MIG</span>
          <span>2026</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // Logic: keep the original line-chart calculations unchanged
    // + integrate pie charts / ROI snapshot + layout controls
    // =========================================================

    const MAX_VAL = 1000000;
    const blackEF = 324;
    const brownEF = 336.6;

    let blackPie, brownPie, roiPie;
    let batteryChartInstance, timeChartInstance;

    function clampNumber(n, min, max) {
      if (!Number.isFinite(n)) return min;
      return Math.min(max, Math.max(min, n));
    }

    function clampInput(id) {
      const el = document.getElementById(id);
      const raw = Number(el.value);
      const clamped = clampNumber(raw, 0, MAX_VAL);
      if (String(el.value) === "" || raw !== clamped) el.value = clamped;
      return clamped;
    }

    function isPdfMode() {
      return document.getElementById("report").classList.contains("pdfMode");
    }

    function getAxisColors() {
      if (isPdfMode()) {
        return {
          tick: "rgba(0,0,0,1)",
          title: "rgba(0,0,0,1)",
          grid: "rgba(0,0,0,0.12)",
          border: "rgba(0,0,0,0.55)",
          legend: "rgba(0,0,0,1)"
        };
      }
      return {
        tick: "rgba(255,255,255,0.88)",
        title: "rgba(255,255,255,0.95)",
        grid: "rgba(255,255,255,0.10)",
        border: "rgba(255,255,255,0.22)",
        legend: "rgba(255,255,255,0.92)"
      };
    }

    function pieOptions(title) {
      const pdf = isPdfMode();
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: title,
            color: pdf ? "#000" : "rgba(255,255,255,0.95)",
            font: { size: 14, weight: "bold" }
          },
          legend: {
            position: "top",
            labels: {
              color: pdf ? "#000" : "rgba(255,255,255,0.92)",
              font: { size: 12, weight: "bold" }
            }
          },
          tooltip: { enabled: true }
        }
      };
    }

    // ✅ Black coal pie uses same colour as line chart (teal) + dark teal remainder
    function drawBlackCoalPie(avoided, total) {
      if (blackPie) blackPie.destroy();

      const safeTotal = Math.max(total, 0);
      const safeAvoided = Math.max(avoided, 0);
      const remaining = Math.max(safeTotal - safeAvoided, 0);
      const percent = safeTotal > 0 ? Math.min((safeAvoided / safeTotal) * 100, 100) : 0;

      const pdf = isPdfMode();
      const offsetColor = pdf ? "#2b77ff" : getComputedStyle(document.documentElement).getPropertyValue("--coalBlackLine").trim();
      const remainColor = pdf ? "#e6e6e6" : "rgba(10, 45, 60, 1)"; // very dark teal

      blackPie = new Chart(document.getElementById("blackPie"), {
        type: "pie",
        data: {
          labels: [
            `Offset Share (${percent.toFixed(1)}%)`,
            "Remaining Emissions"
          ],
          datasets: [{
            data: [safeAvoided, remaining],
            backgroundColor: [offsetColor, remainColor],
            borderColor: pdf ? "#fff" : "rgba(255,255,255,0.9)",
            borderWidth: 2
          }]
        },
        options: pieOptions("Black Coal Offset Share")
      });
    }

    // ✅ Brown coal pie uses line-chart coral/pink + dark coral remainder
    function drawBrownCoalPie(avoided, total) {
      if (brownPie) brownPie.destroy();

      const safeTotal = Math.max(total, 0);
      const safeAvoided = Math.max(avoided, 0);
      const remaining = Math.max(safeTotal - safeAvoided, 0);
      const percent = safeTotal > 0 ? Math.min((safeAvoided / safeTotal) * 100, 100) : 0;

      const pdf = isPdfMode();
      const offsetColor = pdf ? "#ff7a8a" : getComputedStyle(document.documentElement).getPropertyValue("--coalBrownLine").trim();
      const remainColor = pdf ? "#e6e6e6" : "rgba(70, 18, 30, 1)"; // very dark coral

      brownPie = new Chart(document.getElementById("brownPie"), {
        type: "pie",
        data: {
          labels: [
            `Offset Share (${percent.toFixed(1)}%)`,
            "Remaining Emissions"
          ],
          datasets: [{
            data: [safeAvoided, remaining],
            backgroundColor: [offsetColor, remainColor],
            borderColor: pdf ? "#fff" : "rgba(255,255,255,0.9)",
            borderWidth: 2
          }]
        },
        options: pieOptions("Brown Coal Offset Share")
      });
    }

    // ✅ ROI pie: different shades of green
    function drawRoiPie(roiGain) {
      if (roiPie) roiPie.destroy();

      const safeGain = clampNumber(roiGain, 0, 100);
      const pdf = isPdfMode();

      const good = pdf ? "#16a34a" : getComputedStyle(document.documentElement).getPropertyValue("--g3").trim();
      const base = pdf ? "#e6e6e6" : getComputedStyle(document.documentElement).getPropertyValue("--g5").trim();

      roiPie = new Chart(document.getElementById("roiPie"), {
        type: "pie",
        data: {
          labels: [
            `ROI Improvement (${safeGain.toFixed(1)}%)`,
            "Baseline"
          ],
          datasets: [{
            data: [safeGain, 100 - safeGain],
            backgroundColor: [good, base],
            borderColor: pdf ? "#fff" : "rgba(255,255,255,0.9)",
            borderWidth: 2
          }]
        },
        options: pieOptions("ROI Improvement")
      });
    }

    function renderLineCharts(capacity) {
      // Original arrays/logic preserved
      const batteryQuantities = [1, 250, 500, 750, 1000];
      const timeYears = [5, 10, 15, 20];
      const fixedBatteryForTime = 500;

      // ---- DO NOT CHANGE LOGIC ----
      const blackBatteryData = batteryQuantities.map(b => (capacity * 365 * blackEF / 1000) * b);
      const brownBatteryData = batteryQuantities.map(b => (capacity * 365 * brownEF / 1000) * b);

      const blackTimeData = timeYears.map(t => (capacity * 365 * blackEF / 1000) * fixedBatteryForTime * t);
      const brownTimeData = timeYears.map(t => (capacity * 365 * brownEF / 1000) * fixedBatteryForTime * t);
      // ---- DO NOT CHANGE LOGIC ----

      if (batteryChartInstance) batteryChartInstance.destroy();
      if (timeChartInstance) timeChartInstance.destroy();

      const isMobile = window.matchMedia("(max-width: 520px)").matches;
      const c = getAxisColors();

      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: isMobile ? "bottom" : "top",
            labels: {
              color: c.legend,
              boxWidth: 10,
              boxHeight: 10,
              padding: isMobile ? 12 : 18,
              font: { size: isMobile ? 11 : 12, weight: "bold" }
            }
          },
          tooltip: { enabled: true }
        },
        scales: {
          x: {
            ticks: { color: c.tick, font: { size: isMobile ? 11 : 12 } },
            grid: { color: c.grid },
            border: { color: c.border },
            title: { display: true, color: c.title, font: { size: isMobile ? 12 : 14, weight: "bold" } }
          },
          y: {
            ticks: { color: c.tick, font: { size: isMobile ? 11 : 12 } },
            grid: { color: c.grid },
            border: { color: c.border },
            title: { display: true, color: c.title, font: { size: isMobile ? 12 : 14, weight: "bold" } }
          }
        },
        elements: {
          line: { borderWidth: 3, tension: 0.2 },
          point: { radius: isMobile ? 3 : 4, hoverRadius: isMobile ? 5 : 6 }
        }
      };

      batteryChartInstance = new Chart(document.getElementById("batteryChart"), {
        type: "line",
        data: {
          labels: batteryQuantities,
          datasets: [
            {
              label: "Black Coal",
              data: blackBatteryData,
              borderColor: "rgba(71,176,214,1)",
              pointBackgroundColor: "rgba(71,176,214,1)",
              borderWidth: 2,
              fill: false,
              tension: 0.2
            },
            {
              label: "Brown Coal",
              data: brownBatteryData,
              borderColor: "rgba(255,122,138,1)",
              pointBackgroundColor: "rgba(255,122,138,1)",
              borderWidth: 2,
              fill: false,
              tension: 0.2
            }
          ]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales,
            x: { ...commonOptions.scales.x, title: { ...commonOptions.scales.x.title, text: "Number of Batteries" } },
            y: { ...commonOptions.scales.y, title: { ...commonOptions.scales.y.title, text: "Emissions Offset (tonnes/year)" } }
          }
        }
      });

      timeChartInstance = new Chart(document.getElementById("timeChart"), {
        type: "line",
        data: {
          labels: timeYears,
          datasets: [
            {
              label: "Black Coal",
              data: blackTimeData,
              borderColor: "rgba(71,176,214,1)",
              pointBackgroundColor: "rgba(71,176,214,1)",
              borderWidth: 2,
              fill: false,
              tension: 0.2
            },
            {
              label: "Brown Coal",
              data: brownTimeData,
              borderColor: "rgba(255,122,138,1)",
              pointBackgroundColor: "rgba(255,122,138,1)",
              borderWidth: 2,
              fill: false,
              tension: 0.2
            }
          ]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales,
            x: { ...commonOptions.scales.x, title: { ...commonOptions.scales.x.title, text: "Time (Years)" } },
            y: { ...commonOptions.scales.y, title: { ...commonOptions.scales.y.title, text: "Emissions Offset (tonnes)" } }
          }
        }
      });
    }

    function updateAll() {
      // Clamp numeric fields
      const capacity = clampInput("capacity");
      const totalEmissions = clampInput("totalEmissions");
      const cost = clampInput("cost");
      const rN = clampInput("revNormal");
      const rO = clampInput("revOpt");

      // Slider
      const batteries = clampNumber(Number(document.getElementById("batterySlider").value), 0, 1000);
      document.getElementById("batteryCount").innerText = batteries;

      // Annual avoided (pies)
      const annualBlack = (capacity * 365 * blackEF / 1000) * batteries;
      const annualBrown = (capacity * 365 * brownEF / 1000) * batteries;

      drawBlackCoalPie(annualBlack, totalEmissions);
      drawBrownCoalPie(annualBrown, totalEmissions);

      // ROI
      if (cost > 0 && rN > 0 && rO > 0) {
        const pbN = cost / rN;
        const pbO = cost / rO;
        const roiGain = (1 - pbO / pbN) * 100;

        document.getElementById("pbN").innerText = pbN.toFixed(2);
        document.getElementById("pbO").innerText = pbO.toFixed(2);
        document.getElementById("roiGain").innerText = roiGain.toFixed(1);
        document.getElementById("roiSummary").style.display = "block";

        drawRoiPie(roiGain);
      } else {
        document.getElementById("roiSummary").style.display = "none";
        drawRoiPie(0);
      }

      // Line charts (existing logic)
      renderLineCharts(capacity);
    }

    // Submit
    document.getElementById("submitBtn").addEventListener("click", updateAll);

    // Slider live label
    document.getElementById("batterySlider").addEventListener("input", () => {
      document.getElementById("batteryCount").innerText = document.getElementById("batterySlider").value;
    });

    // Enforce range while typing
    ["capacity","totalEmissions","cost","revNormal","revOpt"].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("input", () => clampInput(id));
      el.addEventListener("blur", () => clampInput(id));
    });

    // PDF export (white bg + black axes/text)
    function downloadPDF() {
      const report = document.getElementById("report");
      report.classList.add("pdfMode");
      updateAll();

      const opt = {
        margin: 0.35,
        filename: "optigrid_co2_roi_calculator.pdf",
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "in", format: "a4", orientation: "portrait" }
      };

      html2pdf().from(report).set(opt).save().then(() => {
        report.classList.remove("pdfMode");
        updateAll();
      });
    }

    document.getElementById("pdfBtn").addEventListener("click", downloadPDF);

    // Initial render
    window.addEventListener("load", () => updateAll());

    // Re-render on resize (mobile)
    let resizeTimer;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => updateAll(), 150);
    });
  </script>
</body>
</html>
